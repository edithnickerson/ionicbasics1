# Chapter 7 - Advanced Techniques

We'll cover these subjects with Wilken:

1. Using Sass to modify Ionic styles
2. Handle gestures and events
3. Storing persistent data
4. Platform specifics
5. Configure ionic defaults

The position taken in this chapter is that high-quality apps will require additional features beyond what is standard with Ionic.

The chapter is not a comprehensive example, as before, but rather a set of vignettes designed to illustrate each point.

We'll still clone Wilken's repo:

`git clone https://github.com/ionic-in-action/chapter7.git`

## Custom Ionic Styling

Like Bootstrap, Ionic comes with a full set of styles with useful and established default styles and colors.

However, often these standard colors broadcast that you are using default ionic styles.  This is also evident with [Bootstrap](http://getbootstrap.com/).

### Using Sass

[Sass](http://sass-lang.com/) - Syntactically Awesome Stylesheets is a CSS preprocessor much in the same way that Markdown is a pre-processor for HTML.

Sass is valuable in that it provides things normal CSS doesn't have:
* variables
* nesting
* inheritance

We can access and change these built-in variables used in Ionic's Sass files, to makes changes for your app.

#### Preparing for Sass use in your project

We'll want to ensure that the project is ready to use Sass by installing a utility called `gulp`.

`npm install -g gulp`
`npm install -g gulp-sass`

Then run this:

`ionic setup sass`

While the book doesn't do a good job of making this clear, you'll want to ensure you change directory to:

`chapter7\sass` 

at this point.

Try running `npm install` once there.

Then, we can instruct ionic to use Sass:

First, navigate to the `chapter7/sass` folder, then run:

`npm install gulp` there as well.

#### Changing Ionic Styling Variable values

The variables available for modification in your project are listed here:

`chapter7/sass/www/lib/scss/_variables.scss`

Althought every update of ionic brings potential changes, the version of ionic you used
to create your project places this file in your project.  DO NOT EDIT THIS FILE DIRECTLY! Just use it as a reference.

#### Modifying Ionic Sass Variables

In your project, you'll modify this file:

`chapter7/sass/scss/ionic.app.scss`

When you open this file, it should have just a few lines of Sass code in it.

```javascript
// The path for our ionicons font files, relative to the built CSS in www/css
$ionicons-font-path: "../lib/ionic/fonts" !default;

//MAKE YOUR CUSTOM OVERRIDES HERE

// Include all of Ionic
@import "www/lib/ionic/scss/ionic";
```

In the example from the chapter, this is what the `ionic.app.scss` file looks like:

```javascript
/*
To customize the look and feel of Ionic, you can override the variables
in ionic's _variables.scss file.

For example, you might change some of the default colors:

$light:                           #fff !default;
$stable:                          #f8f8f8 !default;
$positive:                        #387ef5 !default;
$calm:                            #11c1f3 !default;
$balanced:                        #33cd5f !default;
$energized:                       #ffc900 !default;
$assertive:                       #ef473a !default;
$royal:                           #886aea !default;
$dark:                            #444 !default;
*/

// The path for our ionicons font files, relative to the built CSS in www/css
$ionicons-font-path: "../lib/ionic/fonts" !default;

$light: #FAFAFA;
$stable: #EEE;
$positive: #3F51B5;
$calm: #2196F3;
$balanced: #4CAF50;
$energized: #FFC107;
$assertive: #F44336;
$royal: #9C27B0;
$dark: #333;

// Include all of Ionic
@import "www/lib/ionic/scss/ionic";

@import "www/scss/app";
```

This gives a good indication of what is possible in the SCSS file.

#### Regenerating the CSS

We need need to use gulp to regenerate the CSS from the SCSS file.

`gulp sass`

# WARNING

At this stage, there are some real problems with this SASS tool, NodeJS and Ionic.

These problems are described here:

[https://forum.ionicframework.com/t/error-running-gulp-sass/32311/31](https://forum.ionicframework.com/t/error-running-gulp-sass/32311/31)

[http://stackoverflow.com/questions/32552499/error-running-gulp-sass](http://stackoverflow.com/questions/32552499/error-running-gulp-sass)

We'll just have to leave this alone for now.

In general, this is due to the fact that node has changed quite a bit in the last 2 years.

#Detecting if the Device is Offline or Online

You may want to detect your app is offline and react accordingly.

We can either use:

* A cordova plugin
* Listen for online/offline events

The browser (user agent) will help:

`chapter7/offline/www/js/app.js`

```javascript
angular.module('App', ['ionic'])
.run(function($rootScope, $window) {

  alert($window.navigator.onLine);

  $window.addEventListener('offline', function() {
    alert('offline');
    $rootScope.$digest();
  });

  $window.addEventListener('online', function() {
    alert('online');
    $rootScope.$digest();
  });

})
```

## Handling Gestures

We handle gestures and other unique UI interactions two ways in Ionic:

1. Built-in directives used to listen for events
2. Adding event listeners programmatically

### Directives

These are built-in directives that listen for a particular event and call an expression or function.

Events:

* Hold
* Tap
* Drag
* Swipe

#### Events sub-directory

Go to the `chapter7\events` subdirectory and run it.

`ionic serve -p $PORT --nolivereload`

You can see a box icon that you drag around with your finger.

Here is the code that creates the custom directive for the module:

```javascript
.directive('box', function () {
  return {
    restrict: 'E',
    link: function (scope, element) {
      var time = 0, boxX = 0, boxY = 0;
      var leftBound = window.innerWidth - 50;
      var bottomBound = window.innerHeight - 50;
      scope.top = 0;
      scope.left = 0;
      
      scope.startTouch = function (event) {
        time = event.timeStamp;
      };
      scope.endTouch = function (event) {
        console.log('You held the box for ' + (event.timeStamp - time) + 'ms');
        boxX = scope.left;
        boxY = scope.top;
      };
      scope.drag = function (event) {
        var left = boxX + Math.round(event.gesture.deltaX);
        var top = boxY + Math.round(event.gesture.deltaY);

        if (left > leftBound) {
          scope.left = leftBound;
        } else if (left < 0) {
          scope.left = 0;
        } else {
          scope.left = left;
        }
        if (top > bottomBound) {
          scope.top = bottomBound;
        } else if (top < 0) {
          scope.top = 0;
        } else {
          scope.top = top;
        }
      };
    },
    template: '<div id="box" class="icon ion-cube" on-touch="startTouch($event)" on-release="endTouch($event)" on-drag="drag($event)" ng-style="{top: top + \'px\', left: left + \'px\'}"></div>'
  }
})

```

And here is the directive in use:

```html
  <body ng-app="App">
    <box></box>
  </body>
```

The box moves around due to css:

```css
#box {
  position: absolute;
  width: 50px;
  height: 50px;
  font-size: 50px;
  text-align: center;
}
```

### Programmatic Event Handling for Gestures

We can also use the `$ionicGesture` service.

Go to `chapter7/gestures`

We inject `$ionicGesture` into your controller and then declare which events to listen to.

We also specify which element we'll be listening to.  Thus, we should prefer using directives
as directives are best when we need to manipulate the DOM in our templates.

The example supposes that we have a card we want to swipe in our UI.

![Detecting a swipe gesture](http://i39.photobucket.com/albums/e188/ahuimanu/Figure7-2_zpscev7o5ys.png "swipe gesture")

As you can see in the code example, you have finer control over the gesture events with the `$ionicGesture` service.  The code example makes a custom directive to handle the event detection.

This code makes use of a custom directive's `$element` service, which refers to the element defined by the custom directive itself.

```javascript
.directive('card', function () {
  return {
    scope: true,
    controller: function ($scope, $element, $ionicGesture, $interval) {
      $scope.left = 0;

      $ionicGesture.on('drag', function (event) {
        $scope.left = event.gesture.deltaX;
        $scope.$digest();
      }, $element);

      $ionicGesture.on('dragend', function (event) {
        if (Math.abs($scope.left) > (window.innerWidth / 3)) {
          $scope.left = ($scope.left < 0) ? -window.innerWidth : window.innerWidth;
          $element.remove();
        } else {
          var interval = $interval(function () {
            if ($scope.left < 5 && $scope.left > -5) {
              $scope.left = 0;
              $interval.cancel(interval);
            } else {
              $scope.left = ($scope.left < 0) ? $scope.left + 5 : $scope.left - 5;
            }
          }, 5);
        }
        $scope.$digest();
      }, $element);
    },
    transclude: true,
    template: '<div class="list card" ng-style="{left: left + \'px\'}"><div class="item" ng-transclude>Swipe Me</div></div>'
  }
})
```

Look at Table 7.1 in the Wilken book to see each of the Gestures and javascript events available.

#Storage for Persistence

We'll need to store the dat in our apps somehow.  While we have previously played with localStorage in the past,
this section of Chapter 7 discusses the matter further.

Options:

1. LocalStorage
2. IndexedDB (not fully supported)
3. SQLite
4. Web SQL (deprecated)
5. Using a REST service

## LocalStorage

We've alread used local storage.  Some limitations:

* All data is stored as a string
* Size limitations: [http://www.html5rocks.com/en/tutorials/offline/quota-research/](http://www.html5rocks.com/en/tutorials/offline/quota-research/)
 

### Weather App Revisited

If we think about the favorites from the weather app in Chapter 6, we can imagine that the favorite cities may have been persisted so that we have them from execution to execution of the app:

![LocalStorage to hold weather favorites](http://i39.photobucket.com/albums/e188/ahuimanu/Figure7-3_zpsafdagvnq.png "local storage")

Here are some changes we have made to the `Locations` service in the Chapter 6 weather app to use persistence:

```javascript
.factory('Locations', function ($ionicPopup) {
  function store () {
    localStorage.setItem('locations', angular.toJson(Locations.data));
  }

  var Locations = {
    data: [],
    getIndex: function (item) {
      var index = -1;
      angular.forEach(Locations.data, function (location, i) {
        if (item.lat == location.lat && item.lng == location.lng) {
          index = i;
        }
      });
      return index;
    },
    toggle: function (item) {
      var index = Locations.getIndex(item);
      if (index >= 0) {
        $ionicPopup.confirm({
          title: 'Are you sure?',
          template: 'This will remove ' + Locations.data[index].city
        }).then(function (res) {
          if (res) {
            Locations.data.splice(index, 1);
          }
        });
      } else {
        Locations.data.push(item);
        $ionicPopup.alert({
          title: 'Location saved'
        });
      }
      store();
    },
    primary: function (item) {
      var index = Locations.getIndex(item);
      if (index >= 0) {
        Locations.data.splice(index, 1);
        Locations.data.splice(0, 0, item);
      } else {
        Locations.data.unshift(item);
      }
      store();
    }
  };

  try {
    var items = angular.fromJson(localStorage.getItem('locations')) || [];
    Locations.data = items;
  } catch (e) {
    Locations.data = [];
  }

  return Locations;
});
```

Unlike examples that we've covered in the past, this code assumes that have full access to LocalStorage as it is 
naturally a part of the browser and fully accessible via built-in JavaScript APIs.

## Web SQL, IndexedDB, SQLite

These are each client-side (browser) databases.  As relational/SQL databases, they support the use of standard SQL statements.

### Web SQL

This is a deprecated technology that is still supported by iOS and Android.  Avoid.

### IndexedDB

A key-value store, similar to LocalStorage. However, items have fields with specific types and you are able to filter by keys. Not supported by either Android of iOS. Avoid.

### SQLite

Although very common in native iOS and Android, this is NOT supported universally in browsers.  Cordova plugins exist to help.

## Limitations and Future Directions

The advantage of things like SQLite and LocalStorage is that this data can't be viewed by other apps or the user directly.

Web SQL is actually supported natively in iOS and Android.  This is accessible via Cordova plugin.  Wilken speculates that support will shift in favor of IndexedDB.

In either case, it will be necessary to rely on Cordova plugins to ensure consistent behavior.

### Cordova Storage Documentation

In the end, it will be necessary to consult the [Cordova Storage Documentation](http://cordova.apache.org/docs/en/dev/cordova/storage/storage.html#Storage) for authoritative answers here.

The book does discuss ways that we can check to see how the approaches to ionic storage are supported:

```javascript
alert('WebSQL: ' + ((window.openDatabase) ? 'yes' : 'no'));
alert('IndexedDB: ' + ((window.indexedDB ? 'yes' : 'no'));
```

# Multi Platform

While Ionic is cross-platform, there are two main differences between the two platforms Ionic supports;

* appearance
* behavior

The last section of chapter 7 discusses these options extensively.